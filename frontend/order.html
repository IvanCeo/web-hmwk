<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Оформление заказа — Ламповый магазин</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-700 min-h-screen text-white font-sans">

  <!-- Навигация -->
  <nav class="bg-gray-800 px-6 py-4 flex justify-between items-center shadow-xl">
    <div class="flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="36" height="36" class="text-cyan-400 drop-shadow">
        <path d="M12 .75a8.25 8.25 0 0 0-4.135 15.39c.686.398 1.115 1.008 1.134 1.623a.75.75 0 0 0 .577.706c.352.083.71.148 1.074.195.323.041.6-.218.6-.544v-4.661a6.714 6.714 0 0 1-.937-.171.75.75 0 1 1 .374-1.453 5.261 5.261 0 0 0 2.626 0 .75.75 0 1 1 .374 1.452 6.712 6.712 0 0 1-.937.172v4.66c0 .327.277.586.6.545.364-.047.722-.112 1.074-.195a.75.75 0 0 0 .577-.706c.02-.615.448-1.225 1.134-1.623A8.25 8.25 0 0 0 12 .75Z"/>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.013 19.9a.75.75 0 0 1 .877-.597 11.319 11.319 0 0 0 4.22 0 .75.75 0 1 1 .28 1.473 12.819 12.819 0 0 1-4.78 0 .75.75 0 0 1-.597-.876ZM9.754 22.344a.75.75 0 0 1 .824-.668 13.682 13.682 0 0 0 2.844 0 .75.75 0 1 1 .156 1.492 15.156 15.156 0 0 1-3.156 0 .75.75 0 0 1-.668-.824Z"/>
      </svg>
      <span class="text-2xl font-bold tracking-wide">ЛамповыйЗавод</span>
    </div>
    <div class="flex gap-4 items-center">
      <a href="index.html" class="hover:text-cyan-400 transition">Каталог</a>
      <a href="contacts.html" class="hover:text-cyan-400 transition">Контакты</a>
      <a href="order.html" class="hover:text-cyan-400 transition">Заказ</a>
      <a href="login.html" class="ml-4 px-4 py-1 bg-cyan-400 text-gray-900 rounded-lg font-bold hover:bg-cyan-300 transition">Вход</a>
    </div>
  </nav>

  <main class="container mx-auto px-4 md:px-0 mt-12">
    <h1 class="text-4xl font-extrabold mb-10 text-center drop-shadow-lg">Оформление заказа</h1>
    <div class="flex flex-col md:flex-row gap-10">
      <!-- Левая часть -->
      <div class="flex-1 flex flex-col gap-8">
        <!-- Таблица товаров -->
        <div class="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 p-6">
          <h2 class="text-2xl text-cyan-400 font-bold mb-4">Ваш заказ</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700 text-sm" id="products-table">
              <thead class="bg-gray-900">
                <tr>
                  <th class="px-4 py-3 text-left font-semibold text-gray-300">Название</th>
                  <th class="px-4 py-3 text-right font-semibold text-gray-300">Цена</th>
                  <th class="px-4 py-3 text-center font-semibold text-gray-300">Кол-во</th>
                  <th class="px-4 py-3 text-right font-semibold text-gray-300">Сумма</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700">
                <!-- сюда вставятся строки -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Форма данных клиента -->
        <div class="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 p-6">
          <h2 class="text-2xl text-cyan-400 font-bold mb-4">Данные для доставки</h2>
          <form id="order-form" class="flex flex-col gap-4" novalidate>
            <div>
              <label for="name" class="block mb-1 text-gray-300">Имя</label>
              <input type="text" id="name" class="w-full px-4 py-2 rounded-lg bg-gray-900 border border-gray-700 focus:border-cyan-400 focus:outline-none text-white" required value="Иванов">
            </div>
            <div>
              <label for="email" class="block mb-1 text-gray-300">E-mail</label>
              <input type="email" id="email" class="w-full px-4 py-2 rounded-lg bg-gray-900 border border-gray-700 focus:border-cyan-400 focus:outline-none text-white" required value="test@mail.ru">
            </div>
            <div>
              <label for="phone" class="block mb-1 text-gray-300">Телефон</label>
              <input type="tel" id="phone" class="w-full px-4 py-2 rounded-lg bg-gray-900 border border-gray-700 focus:border-cyan-400 focus:outline-none text-white" required value="+79000000000">
            </div>
            <div>
              <label for="address" class="block mb-1 text-gray-300">Адрес доставки</label>
              <textarea id="address" class="w-full px-4 py-2 rounded-lg bg-gray-900 border border-gray-700 focus:border-cyan-400 focus:outline-none text-white" rows="3" required>Предзаполненный адрес доставки, для экономии времени при разработке сервиса.</textarea>
            </div>
          </form>
        </div>
      </div>
      <!-- Сайдбар -->
      <div class="md:w-80 w-full flex-shrink-0">
        <div class="bg-gray-800 rounded-2xl shadow-xl border border-gray-700 p-6 flex flex-col gap-4 sticky top-8">
          <h3 class="text-xl font-bold mb-2 text-cyan-400">Итого</h3>
          <p>Позиций в заказе: <span id="summary-count" class="text-cyan-400">0</span></p>
          <p>Общее кол-во: <span id="summary-qty" class="text-cyan-400">0</span> шт.</p>
          <p class="text-lg font-bold">Сумма: <span id="summary-sum" class="text-cyan-400">0 руб.</span></p>
          <button id="submit-order" class="w-full py-3 bg-cyan-400 text-gray-900 font-bold rounded-lg hover:bg-cyan-300 transition mt-2">
            Оформить заказ
          </button>
        </div>
      </div>
    </div>
  </main>

  <footer class="mt-12 p-4 bg-gray-900 text-center text-sm text-gray-400 rounded-t-2xl shadow-inner">
    2025 © Ламповый завод — фабрика по производству ламп различного назначения.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const tableBody = document.querySelector('#products-table tbody');
      const summaryCount = document.getElementById('summary-count');
      const summaryQty = document.getElementById('summary-qty');
      const summarySum = document.getElementById('summary-sum');

      // 0. Читаем текущую корзину из sessionStorage
      const cart = JSON.parse(sessionStorage.getItem('cart') || '[]');

      // 1. Загружаем все товары
      let products = [];
      try {
        const resp = await axios.get('/api/v1/products/');
        products = resp.data;
      } catch (e) {
        return alert('Не удалось загрузить список товаров');
      }

      // 2. Рендерим строки таблицы, подставляя сохранённые в cart количества
      products.forEach((p, idx) => {
        const tr = document.createElement('tr');
        const saved = cart.find(i => i.product_id === p.id);
        const qtyValue = saved ? saved.quantity : 0;
        tr.innerHTML = `
          <td class="px-4 py-3">${p.name}</td>
          <td class="px-4 py-3 text-right">${p.price} руб.</td>
          <td class="px-4 py-3 text-center">
            <input
              type="number"
              min="0"
              value="${qtyValue}"
              class="form-control qty w-20 px-2 py-1 rounded-lg bg-gray-900 border border-gray-700 text-white text-center"
              data-id="${p.id}"
            >
          </td>
          <td class="px-4 py-3 text-right"><span class="line-sum">0</span> руб.</td>
        `;
        tableBody.appendChild(tr);
      });

      // 3. Функция пересчёта итогов и сохранения cart
      function recalc() {
        const rows = tableBody.querySelectorAll('tr');
        let count = 0, qty = 0, sum = 0;
        const newCart = [];
        rows.forEach((tr, idx) => {
          const input = tr.querySelector('.qty');
          let q = Math.max(0, parseInt(input.value) || 0);
          const price = products[idx].price;
          const lineSum = price * q;
          tr.querySelector('.line-sum').textContent = lineSum;
          if (q > 0) {
            count += 1;
            qty += q;
            sum += lineSum;
            newCart.push({ product_id: products[idx].id, quantity: q });
          }
        });
        sessionStorage.setItem('cart', JSON.stringify(newCart));
        summaryCount.textContent = count;
        summaryQty.textContent = qty;
        summarySum.textContent = sum + ' руб.';
      }

      // 4. Слушатель на изменение любого input.qty
      tableBody.addEventListener('input', e => {
        if (e.target.classList.contains('qty')) {
          const id = +e.target.dataset.id;
          const prod = products.find(x => x.id === id);
          if (prod && e.target.value > prod.stock_quantity) {
            e.target.value = prod.stock_quantity;
          }
          recalc();
        }
      });

      // 5. Запускаем recalc один раз после отрисовки, чтобы применить сохранённые данные
      recalc();

      // 6. Отправка заказа
      document.getElementById('submit-order').addEventListener('click', async () => {
        const form = document.getElementById('order-form');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const items = JSON.parse(sessionStorage.getItem('cart') || '[]');
        if (items.length === 0) {
          return alert('Укажите количество хотя бы для одного товара');
        }
        const data = {
          customer_name: form.querySelector('#name').value,
          customer_email: form.querySelector('#email').value,
          customer_phone: form.querySelector('#phone').value,
          delivery_address: form.querySelector('#address').value,
          comment: form.querySelector('#comment')?.value || '',
          items
        };
        try {
          const res = await axios.post('/api/v1/orders/', data);
          sessionStorage.removeItem('cart');
          window.location.href = `confirm.html?order_id=${res.data.id}`;
        } catch (err) {
          console.error('Ошибка создания заказа', err);
          alert('Не удалось создать заказ');
        }
      });
    });
  </script>
</body>
</html>
